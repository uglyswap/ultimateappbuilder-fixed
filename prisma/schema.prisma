// Prisma Schema for Ultimate App Builder

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  avatar        String?
  role          UserRole  @default(USER)

  // Subscription
  subscriptionTier   SubscriptionTier @default(FREE)
  subscriptionStatus String?
  stripeCustomerId   String?          @unique

  // Preferences & Settings
  preferences   Json?  @default("{}")
  autonomousMode Boolean @default(true)  // YOLO mode enabled by default
  customSystemPrompts Json? @default("{}") // Custom prompts per agent type

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  projects      Project[]
  apiKeys       ApiKey[]
  generations   Generation[]
  customPrompts CustomPrompt[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// API Keys for programmatic access
model ApiKey {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

// Projects generated by users
model Project {
  id              String        @id @default(cuid())
  name            String
  description     String?
  template        ProjectTemplate
  status          ProjectStatus @default(DRAFT)

  // Configuration
  config          Json
  features        String[]

  // Generated code metadata
  generatedPath   String?
  repositoryUrl   String?
  deploymentUrl   String?

  // Ownership
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deployedAt      DateTime?

  // Relations
  generations     Generation[]
  deployments     Deployment[]

  @@index([userId])
  @@index([status])
  @@map("projects")
}

enum ProjectTemplate {
  SAAS
  ECOMMERCE
  BLOG
  API
  CUSTOM
}

enum ProjectStatus {
  DRAFT
  GENERATING
  READY
  DEPLOYING
  DEPLOYED
  ERROR
}

// AI Generations Log
model Generation {
  id              String           @id @default(cuid())
  projectId       String
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Generation details
  agentType       AgentType
  prompt          String           @db.Text
  response        String           @db.Text
  status          GenerationStatus @default(PENDING)

  // Metadata
  tokensUsed      Int              @default(0)
  durationMs      Int?
  errorMessage    String?          @db.Text

  // Timestamps
  createdAt       DateTime         @default(now())
  completedAt     DateTime?

  @@index([projectId])
  @@index([userId])
  @@index([status])
  @@map("generations")
}

enum AgentType {
  ORCHESTRATOR
  BACKEND
  FRONTEND
  DATABASE
  AUTH
  INTEGRATIONS
  DEVOPS
  DESIGNER
}

enum GenerationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// Deployments
model Deployment {
  id              String           @id @default(cuid())
  projectId       String
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Deployment info
  provider        DeploymentProvider
  status          DeploymentStatus @default(PENDING)
  url             String?

  // Configuration
  environment     String           @default("production")
  config          Json

  // Logs
  buildLog        String?          @db.Text
  errorLog        String?          @db.Text

  // Timestamps
  createdAt       DateTime         @default(now())
  deployedAt      DateTime?

  @@index([projectId])
  @@index([status])
  @@map("deployments")
}

enum DeploymentProvider {
  VERCEL
  NETLIFY
  AWS
  DOCKER
  CUSTOM
}

enum DeploymentStatus {
  PENDING
  BUILDING
  DEPLOYING
  SUCCESS
  FAILED
}

// Templates Library
model Template {
  id              String   @id @default(cuid())
  name            String
  description     String
  category        String

  // Category relation
  categoryId      String?
  categoryObj     TemplateCategory? @relation("CategoryTemplates", fields: [categoryId], references: [id])

  // Template content
  structure       Json
  dependencies    Json
  configuration   Json

  // Preview & Demo
  previewUrl      String?
  demoUrl         String?
  thumbnailUrl    String?
  screenshots     String[]

  // Features & Tags
  features        String[]
  tags            String[]
  isPremium       Boolean  @default(false)
  isOfficial      Boolean  @default(false)

  // Metadata
  version         String   @default("1.0.0")
  downloads       Int      @default(0)
  rating          Float?
  author          String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([isPremium])
  @@map("templates")
}

// System Jobs Queue
model Job {
  id              String    @id @default(cuid())
  type            String
  payload         Json
  status          JobStatus @default(PENDING)

  // Processing
  attempts        Int       @default(0)
  maxAttempts     Int       @default(3)
  errorMessage    String?   @db.Text

  // Progress tracking
  progress        Int       @default(0) // 0-100
  currentStep     String?
  totalSteps      Int       @default(1)

  // Timestamps
  createdAt       DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  scheduledFor    DateTime?

  @@index([status])
  @@index([type])
  @@map("jobs")
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Custom System Prompts
model CustomPrompt {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Prompt details
  name            String
  description     String?
  agentType       AgentType
  prompt          String   @db.Text
  isActive        Boolean  @default(true)

  // Metadata
  version         String   @default("1.0.0")
  tags            String[]
  usageCount      Int      @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([agentType])
  @@map("custom_prompts")
}

// Premium Template Categories
model TemplateCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  icon        String?
  order       Int        @default(0)
  templates   Template[] @relation("CategoryTemplates")

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("template_categories")
}

// Database Configuration Presets
model DatabasePreset {
  id              String   @id @default(cuid())
  name            String
  description     String
  type            String   // postgresql, mysql, mongodb, sqlite, supabase, planetscale
  connectionString String  @db.Text
  autoSetup       Boolean  @default(true)
  schema          Json?    // Pre-defined schema
  migrations      Json?    // Auto-migration scripts

  // Cloud provider integration
  provider        String?  // supabase, planetscale, neon, railway
  providerConfig  Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("database_presets")
}

// System Configuration - Store API keys and settings securely
model SystemConfig {
  id              String   @id @default(cuid())
  key             String   @unique
  value           String   @db.Text  // Encrypted value
  category        String   // ai, integration, email, storage, etc.
  description     String?
  isEncrypted     Boolean  @default(true)
  isRequired      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([key])
  @@map("system_configs")
}
